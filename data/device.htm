<html>
 <head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.6/lumen/bootstrap.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Страница устройств</title>
  <script>
   function load(){
    if (window.XMLHttpRequest) {
     xhttp = new XMLHttpRequest();
    } else {
     xhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    iplocation();
    document.getElementById('date').innerHTML = new Date().toLocaleString("ru", {day:"numeric",weekday:"long"})+'<br><small>'+new Date().toLocaleString("ru", {year:"numeric",month:"long"})+'<\/small>';
   }

   function finddevice() {
    $("#content").html('<div class="alert alert-dismissible alert-info"><strong>Пожалуйста подождите, идет сканирование сети.</strong></div>');
    $.get("./Devices?"+Math.floor(Math.random()*10000), function(data) {
     setTimeout(function(){iplocation()}, 5000);
    });
   }

   function iplocation() {
    $("#content").html("");
    xhttp.open("GET", "./iplocation.xml?"+Math.floor(Math.random()*10000), false);
    xhttp.send();
    xmlDoc = xhttp.responseXML;
    var count=xmlDoc.getElementsByTagName("ip").length;
    for (i = 0; i < count ;i++) {
     var ipval = xmlDoc.getElementsByTagName("ip")[i].childNodes[0].textContent;
     console.log(ipval);
     $.get("http://"+ipval+"/block?"+Math.floor(Math.random()*10000), function(data) {
      $(data).prependTo("#content").fadeIn("slow");
     });
    }
   }

   function ajax(pagename, submit) {
    old_submit = submit.value;
    submit.value = 'Подождите...';
    $.get("http://"+pagename, function(data) {
     submit.value=old_submit;
    });
   }
  </script>
 </head>
 <body onload="load();">
  <div class="container device">
   <div class="header">
    <h4><small class="pull-right col-md-4" style="padding:15px 0;">Здесь видны все ваши устройства умного дома, скачать прошивки для ESP 01 вы можете на <a href="https://github.com/tretyakovsa/jaluzi" target="_blank">github</a>. Если устройство не появляется попробуйте <a href="./device.htm">обновить</a> страницу. Появились какие-то вопросы, пишите <a href="https://github.com/tretyakovsa/jaluzi/issues/new" target="_blank">сюда</a>.</small></h4>
    <h1 id="date"><br><small></small></h1>
   </div>
   <div class="row">
    <div class="col-sm-3">
     <h5 style="background-color:#C0C7CA">История</h5>
     <ul id="history">
      <li>Скоро...</li>
      <li>Скоро...</li>
      <li>Скоро...</li>
     </ul>
     <hr>
     <a href="#" class="btn btn-success btn-sm align-right" onclick="finddevice();">Найти новые устройсва</a>
    </div>
    <div class="col-sm-offset-0 col-sm-9" style="text-align:center;" id="content"></div>
   </div>
  </div>
 </body>
</html>
