<html>
 <head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.6/lumen/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Доп. настройки</title>
  <script>
   var xmlHttp=createXmlHttpObject();
   function createXmlHttpObject(){
    if(window.XMLHttpRequest){
     xmlHttp=new XMLHttpRequest();
    }else{
     xmlHttp=new ActiveXObject('Microsoft.XMLHTTP');
    }
    return xmlHttp;
   }
   function load(){
    if(xmlHttp.readyState==0 || xmlHttp.readyState==4){
     xmlHttp.open('PUT','config.xml',true);
     xmlHttp.onreadystatechange=handleServerResponse;
     xmlHttp.send(null);
    }
   }
   function handleServerResponse(){
    if(xmlHttp.readyState==4 && xmlHttp.status==200){
     xmlResponse=xmlHttp.responseXML;

     xmldoc = xmlResponse.getElementsByTagName('timezone');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('timezone').value=message;

     xmldoc = xmlResponse.getElementsByTagName('time');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('time').innerHTML=message;

     xmldoc = xmlResponse.getElementsByTagName('ssid');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('ssid').value=message;

     xmldoc = xmlResponse.getElementsByTagName('password');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('password').value=message;

     xmldoc = xmlResponse.getElementsByTagName('ssidAP');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('ssidap').value=message;

     xmldoc = xmlResponse.getElementsByTagName('passwordAP');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('passwordAp').value=message;

     xmldoc = xmlResponse.getElementsByTagName('onOffAP');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('onOffAP').checked=message;

     xmldoc = xmlResponse.getElementsByTagName('SSDP');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('ssdp').value=message;

     xmldoc = xmlResponse.getElementsByTagName('kolibr');
     message = xmldoc[0].firstChild.nodeValue;
     document.getElementById('kolibr').value=message;
    }
   }
   function load_time(submit){
    server = "/Time";
    send_request(submit,server);
   }
   function Time_Zone(submit){
    timezone = document.getElementById('timezone').value;
    server = "/TimeZone?timezone="+timezone;
    send_request(submit,server);
   }
   function set_time_Zone(submit){
    var set_date = new Date();
    var gmtHours = -set_date.getTimezoneOffset()/60;
    document.getElementById('timezone').value = gmtHours;
    server = "/TimeZone?timezone="+gmtHours;
    send_request(submit,server);
   }
   function set_Ssid(submit){
    ssid = document.getElementById('ssid').value;
    password = document.getElementById('password').value;
    server = "/ssid?ssid="+ssid+"&password="+password;
    send_request(submit,server);
   }
   function set_SsidAP(submit){
    ssid = document.getElementById('ssidap').value;
    password = document.getElementById('passwordAp').value;
    onoff = document.getElementById('onOffAP').checked;
    server = "/ssidap?ssidAP="+ssid+"&passwordAP="+password+"&onOffAP="+onoff;
    send_request(submit,server);
   }
   function kolibr(submit){
    kolibr = document.getElementById('kolibr').value;
    server = "/kolibr?kolibr="+kolibr;
    send_request(submit,server);
   }
   function set_ssdp(submit){
    ssdp = document.getElementById('ssdp').value;
    server = "/ssdp?ssdp="+ssdp;
    send_request(submit,server);
   }
   function send_request(submit,server){
    request = new XMLHttpRequest();
    request.open("GET", server, true);
    request.send();
    save_status(submit,request);
   }
   function save_status(submit,request){
    old_submit = submit.value;
    request.onreadystatechange = function() {
     if (request.readyState != 4) return;
     submit.value = request.responseText;
     setTimeout(function(){submit.value=old_submit}, 3000);
    }
    submit.value = 'Подождите...';
   }
  </script>
 </head>
 <body onload="load();">
  <div class="container">
   <div class="row" style="text-align:center;">
    <h1 style="margin:40px;">Доп. настройки</h1>
    <div class="col-sm-offset-2 col-sm-8 col-md-offset-3 col-md-6">
     <a class="btn btn-block btn-danger" href="./device.htm">Страница устройств</a>
     <hr>
     <div class="alert alert-dismissible alert-warning">Пожалуйста подключитесь к своему роутеру и укажите ниже вашу GMT зону.
      Это позволит унавать время, которое будит синхранизируется 1 раз в сутки в 03:00 используя ваш роутер. Вы так же сможете управлять вашим устройством в локальной сети.</div>
     <div class="alert alert-dismissible alert-info">
      Здесь вы можете загрузить bin файл в ESP или <a href="./edit" target="_blank">редактировать HTML</a>:
      <form method="POST" action="/update" enctype="multipart/form-data">
       <div class="btn-group">
        <input type="file" class="btn btn-primary btn-xs" name="update" style="height: 33px;">
        <input type="submit" class="btn btn-default btn-sm" value="загрузить" onclick="this.value='Подождите...';" style="height: 33px;">
       </div>
      </form>
     </div>
     <h2>Имя устройства</h2>
     <input id="ssdp" value="" class="form-control" pattern="[0-9a-zA-Zа-яА-Я. ]{1,20}" placeholder="Имя устройства">
     <input class="btn btn-block btn-success" value="Сохранить" onclick="set_ssdp(this);" type="submit">
     <hr>

     <h2>Подключение к WiFi роутеру</h2>
     <input id="ssid" value="" class="form-control" pattern="[0-9a-zA-Z.]{1,15}" placeholder="Имя WiFi сети">
     <input id="password" value="" pattern="[0-9a-zA-Z.]{8,15}" class="form-control" placeholder="Пароль">
     <input class="btn btn-block btn-success" value="Сохранить" onclick="set_Ssid(this);" type="submit">
     <hr>
     <h2>Временная зона GMT</h2>
     <input id="timezone" value="" pattern="[0-9]{1,3}" class="form-control">
     <input class="btn btn-block btn-success" value="Сохранить" onclick="Time_Zone(this);" type="submit">
     <input class="btn btn-block btn-primary" value="Авто определение и сохранение зоны" onclick="set_time_Zone(this);" type="submit">
     <h2>На устройстве сейчас <strong id="time">00:00:00</strong></h2>
     <input class="btn btn-block btn-primary" value="Синхронизировать время" onclick="load_time(this);" type="submit">
     <hr>
     <h2>WiFi Жалюзи</h2>
     <div class="row">
      <div class="col-sm-6">
       <label class="form-control"><input type="checkbox" id="onOffAP"> <b>Включить\выключить WiFi</b></label>
       <input id="ssidap" value="" class="form-control" pattern="[0-9a-zA-Z.]{1,15}" placeholder="Имя WiFi сети">
       <input id="passwordAp" value="" pattern="[0-9a-zA-Z.]{8,15}" class="form-control" placeholder="Пароль">
       <input class="btn btn-block btn-success" value="Сохранить" onclick="set_SsidAP(this);" type="submit">
      </div>
      <div class="col-sm-6">
       <div class="alert alert-dismissible alert-info">Здесь можете указать новое название Wi-Fi жалюзи и пароль. После этого необходимо перезагрузить ESP.</div>
      </div>
     </div>
     <hr>
     <h2>Колибровка мотора</h2>
     <div class="row">
      <div class="col-sm-8">
       <div class="alert alert-dismissible alert-info">Если серво двигатель постоянно крутится его необходимо отколибровать. Поэксперементируйте здесь с цифрами. Как правило они калеблятся от 90 до 95.</div>
      </div>
      <div class="col-sm-4">
       <input id="kolibr" value="" pattern="[0-9]{1,2}" class="form-control">
       <input class="btn btn-block btn-success" value="Сохранить" onclick="kolibr(this);" type="submit">
      </div>
     </div>
     <hr>
     <a class="btn btn-block btn-default" href="./">Страница управления</a>
    </div>
   </div>
  </div>
 </body>
</html>
